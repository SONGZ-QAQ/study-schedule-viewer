<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习计划可视化 (带进度条)</title>
    <style>
        /* --- 整体样式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }

        /* --- 主容器 --- */
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 30px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #1a237e;
            margin-bottom: 30px;
        }

        /* --- 状态面板 --- */
        .status-panel {
            background-color: #e8eaf6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #c5cae9;
        }

        .status-panel h2 {
            margin-top: 0;
            color: #3f51b5;
        }

        #current-task {
            font-size: 1.2em;
            font-weight: bold;
            min-height: 30px;
        }

        #countdown {
            font-size: 1.5em;
            color: #d32f2f;
            font-weight: bold;
        }

        #copy-button {
            background-color: #3f51b5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        #copy-button:hover {
            background-color: #303f9f;
        }

        /* --- 时间轴 --- */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 50px;
            top: 0;
            width: 4px;
            height: 100%;
            background: #e0e0e0;
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 80px;
            transition: all 0.3s ease;
        }
        
        .timeline-item.past {
            opacity: 0.5;
        }

        .timeline-item.current {
            transform: scale(1.03);
            /* 确保放大时围绕时间轴点（timeline dot）为原点，避免向左偏移 */
            transform-origin: 40px center;
        }
        .timeline-item.current .timeline-content{
             border: 2px solid #3f51b5;
             box-shadow: 0 2px 8px rgba(63, 81, 181, 0.4);
        }

        .timeline-time {
            position: absolute;
            left: -20px;
            top: 10px;
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
            width: 80px;
            text-align: center;
        }

        .timeline-dot {
            position: absolute;
            left: 40px;
            top: 8px;
            width: 20px;
            height: 20px;
            background: #bdbdbd;
            border-radius: 50%;
            border: 3px solid #f0f2f5;
        }

        .timeline-item.current .timeline-dot {
            background: #3f51b5;
        }

        .timeline-content {
            position: relative; /* 关键：为进度条提供定位上下文 */
            background: #f9f9f9;
            padding: 15px 20px;
            border-radius: 8px;
            border: 2px solid transparent;
            overflow: hidden; /* 关键：确保进度条不会超出圆角 */
        }

        .timeline-content h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            color: #333;
            position: relative; /* 关键：确保文字在进度条之上 */
            z-index: 1;
        }

        /* --- 新增：进度条样式 --- */
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%; /* 初始宽度为0 */
            background-color: rgba(63, 81, 181, 0.2); /* 半透明蓝色 */
            border-radius: 6px;
            transition: width 0.5s ease-out; /* 让进度条变化更平滑 */
            z-index: 0; /* 确保在文字下方 */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>学习计划可视化面板</h1>

        <div class="status-panel">
            <h2>当前状态</h2>
            <p id="current-task">正在初始化...</p>
            <p id="countdown">--:--:--</p>
            <button id="copy-button">复制当前任务</button>
        </div>

        <div class="timeline" id="timeline-container">
            <!-- JavaScript将在这里动态生成时间轴内容 -->
        </div>
    </div>

    <script>
        const schedule = [
            { start: "06:00", end: "07:10", description: "政治音频带背" },
            { start: "07:10", end: "07:40", description: "去大厅念两遍 333 回来默写杠杠框架" },
            { start: "07:40", end: "09:40", description: "背诵现汉+课后题" },
            { start: "09:40", end: "11:50", description: "英语 2+2" },
            { start: "11:50", end: "13:50", description: "吃快点，一定要午休" },
            { start: "14:10", end: "14:25", description: "快速过一遍现汉" },
            { start: "14:25", end: "16:25", description: "背诵两章 333，一定要背完！偷懒就滚！" },
            { start: "16:25", end: "18:00", description: "整理五篇作品" },
            { start: "18:00", end: "19:00", description: "吃快点回来可以趴一会儿" },
            { start: "19:00", end: "21:30", description: "75min 政治 + 75min 作文" },
            { start: "21:30", end: "22:30", description: "通勤 洗澡" },
            { start: "22:30", end: "23:30", description: "整理 809+单词" }
        ];

        const timelineContainer = document.getElementById('timeline-container');
        const currentTaskEl = document.getElementById('current-task');
        const countdownEl = document.getElementById('countdown');
        const copyButton = document.getElementById('copy-button');
        
        let currentTaskDescription = "暂无任务";

        function getTimeFromString(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const date = new Date();
            date.setHours(parseInt(hours, 10), parseInt(minutes, 10), 0, 0);
            return date;
        }

        function buildTimeline() {
            let html = '';
            schedule.forEach(task => {
                // 在每个任务内容中添加一个 progress-bar 元素
                html += `
                    <div class="timeline-item" data-start="${task.start}" data-end="${task.end}">
                        <div class="timeline-time">${task.start}</div>
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="progress-bar"></div>
                            <h3>${task.description}</h3>
                        </div>
                    </div>
                `;
            });
            timelineContainer.innerHTML = html;
        }

        function update() {
            const now = new Date();
            let currentTask = null;
            let nextTask = null;

            for (let i = 0; i < schedule.length; i++) {
                const task = schedule[i];
                const startTime = getTimeFromString(task.start);
                const endTime = getTimeFromString(task.end);
                if (now >= startTime && now < endTime) currentTask = task;
                if (now < startTime && !nextTask) nextTask = task;
            }

            if (currentTask) {
                currentTaskDescription = `[${currentTask.start}-${currentTask.end}] ${currentTask.description}`;
                currentTaskEl.textContent = currentTask.description;
            } else {
                 currentTaskDescription = "当前是休息时间";
                 currentTaskEl.textContent = "当前是休息时间";
            }

            if (nextTask) {
                const diff = getTimeFromString(nextTask.start) - now;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                countdownEl.textContent = `距离下个任务: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else if (currentTask) {
                // 当没有下一个任务但当前正在进行某个任务时，显示距离本任务结束的倒计时（避免在最后一条任务进行中就显示“全部完成”）
                const endTime = getTimeFromString(currentTask.end);
                const diff = endTime - now;
                if (diff > 0) {
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    countdownEl.textContent = `距离本任务结束: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    countdownEl.textContent = "今日计划已全部完成！";
                }
            } else {
                countdownEl.textContent = "今日计划已全部完成！";
            }
            
            // --- 核心更新：更新时间轴和进度条 ---
            const timelineItems = document.querySelectorAll('.timeline-item');
            timelineItems.forEach(item => {
                const startTime = getTimeFromString(item.dataset.start);
                const endTime = getTimeFromString(item.dataset.end);
                const progressBar = item.querySelector('.progress-bar');
                
                item.classList.remove('current', 'past');
                let progressPercent = 0;

                if (now >= startTime && now < endTime) {
                    item.classList.add('current');
                    const duration = endTime - startTime;
                    const elapsed = now - startTime;
                    progressPercent = Math.min((elapsed / duration) * 100, 100);
                } else if (now >= endTime) {
                    item.classList.add('past');
                    progressPercent = 100;
                }
                
                progressBar.style.width = `${progressPercent}%`;
            });
        }
        
        // 兼容移动端的复制函数：优先使用 navigator.clipboard，失败时回退到 textarea + execCommand
        async function copyTextToClipboard(text) {
            if (!text) return false;
            // 首选现代 API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (e) {
                    // 若因权限/上下文问题失败，继续走回退
                    // console.warn('navigator.clipboard.writeText failed:', e);
                }
            }

            // 回退方法：创建隐藏 textarea，选中并执行 document.execCommand('copy')
            try {
                const textArea = document.createElement('textarea');
                // 避免页面滚动
                textArea.style.position = 'fixed';
                textArea.style.top = '0';
                textArea.style.left = '0';
                textArea.style.width = '2em';
                textArea.style.height = '2em';
                textArea.style.padding = '0';
                textArea.style.border = 'none';
                textArea.style.outline = 'none';
                textArea.style.boxShadow = 'none';
                textArea.style.background = 'transparent';
                textArea.value = text;

                document.body.appendChild(textArea);

                // iOS 需要先选择范围
                textArea.focus();
                textArea.select();
                textArea.setSelectionRange(0, textArea.value.length);

                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return successful;
            } catch (e) {
                // console.error('fallback copy failed', e);
                return false;
            }
        }

        copyButton.addEventListener('click', async () => {
            const ok = await copyTextToClipboard(currentTaskDescription);
            if (ok) {
                copyButton.textContent = '已复制!';
                setTimeout(() => { copyButton.textContent = '复制当前任务'; }, 2000);
            } else {
                // 在移动端若复制失败，给出提示并尝试使用 prompt 作为最后手段
                // prompt 在某些浏览器会弹出并允许用户手动复制
                try {
                    // iOS Safari 在无 https 或某些环境下可能会失败，上报并提示
                    window.prompt('请长按并复制下面的内容：', currentTaskDescription);
                } catch (e) {
                    // 最后兜底：改变按钮文字提示
                    copyButton.textContent = '复制失败，请长按文本手动复制';
                    setTimeout(() => { copyButton.textContent = '复制当前任务'; }, 3000);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            buildTimeline();
            update();
            setInterval(update, 1000);
        });
    </script>
</body>
</html>